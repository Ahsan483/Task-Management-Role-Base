<!-- eslint-disable @angular-eslint/template/label-has-associated-control -->
<!-- eslint-disable @angular-eslint/template/prefer-control-flow -->
<div class="bg-white rounded-lg shadow p-6">
  <h2 class="text-2xl font-bold text-gray-900 mb-6">Organization Users (Owner Only)</h2>

  <!-- Access Control Notice -->
  <div *ngIf="user$ | async as user" class="mb-6">
    <div *ngIf="user.role !== 'Owner'" class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
      <p class="text-red-800 font-semibold">Access Denied</p>
      <p class="text-red-700 text-sm mt-2">User management is only available to the Organization Owner.</p>
    </div>
    <div *ngIf="user.role === 'Owner'" class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
      <p class="text-green-800 text-sm">
        <span class="font-semibold">✓ Owner Access.</span> You can manage organization users and roles here.
      </p>
    </div>
  </div>

  <!-- Error Alert -->
  <div *ngIf="error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6 flex justify-between items-center">
    <div>
      <p class="font-bold">Error</p>
      <p class="text-sm">{{ error }}</p>
    </div>
    <button (click)="error = null" class="text-red-700 hover:text-red-900">×</button>
  </div>

  <!-- Owner Only Content -->
  <div *ngIf="user$ | async as user">
    <div *ngIf="user.role === 'Owner'" class="space-y-6">
      <!-- Create Admin Button -->
      <div>
        <button
          (click)="showAdminForm = !showAdminForm"
          class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition"
        >
          {{ showAdminForm ? 'Cancel' : '+ Create Admin' }}
        </button>
      </div>

      <!-- Create Admin Form -->
      <div *ngIf="showAdminForm" class="bg-gray-50 p-4 rounded border border-blue-300">
        <h3 class="font-semibold text-lg mb-4">Create New Admin User</h3>
        <form [formGroup]="adminForm" (ngSubmit)="createAdmin()" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Email</label>
            <input
              type="email"
              formControlName="email"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
              placeholder="admin@example.com"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Name</label>
            <input
              type="text"
              formControlName="name"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
              placeholder="Admin Name"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Password</label>
            <input
              type="password"
              formControlName="password"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
              placeholder="Enter password"
            />
          </div>
          <div class="flex space-x-2">
            <button
              type="submit"
              [disabled]="adminForm.invalid"
              class="flex-1 bg-green-500 text-white py-2 rounded hover:bg-green-600 disabled:bg-gray-400 transition"
            >
              Create Admin
            </button>
            <button
              type="button"
              (click)="showAdminForm = false"
              class="flex-1 bg-gray-400 text-white py-2 rounded hover:bg-gray-500 transition"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>

      <!-- Users Table -->
      <div *ngIf="!loading" class="overflow-x-auto">
        <table class="min-w-full border border-gray-200 rounded-lg">
          <thead class="bg-gray-100 border-b-2 border-gray-300">
            <tr>
              <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Name</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Email</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Role</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            <tr *ngFor="let orgUser of users" class="hover:bg-gray-50 transition">
              <td class="px-4 py-3 text-sm text-gray-800 font-medium">{{ orgUser.name }}</td>
              <td class="px-4 py-3 text-sm text-gray-800">{{ orgUser.email }}</td>
              <td class="px-4 py-3 text-sm">
                <span [ngClass]="getRoleBadgeColor(orgUser.role)" class="px-3 py-1 rounded text-xs font-bold">
                  {{ orgUser.role }}
                </span>
              </td>
              <td class="px-4 py-3 text-sm">
                <button
                  *ngIf="orgUser.role !== 'Owner'"
                  (click)="changeRole(orgUser.id, orgUser.role)"
                  class="text-blue-500 hover:text-blue-700 font-medium"
                >
                  {{ orgUser.role === 'Admin' ? 'Demote to Viewer' : 'Promote to Admin' }}
                </button>
                <span *ngIf="orgUser.role === 'Owner'" class="text-gray-500 font-medium">
                  Organization Owner
                </span>
              </td>
            </tr>
          </tbody>
        </table>

        <div *ngIf="users.length === 0" class="text-center py-8 text-gray-500 bg-gray-50 rounded-lg">
          <p class="text-lg font-medium">No users in organization</p>
        </div>
      </div>

      <div *ngIf="loading" class="text-center py-8">
        <p class="text-gray-500">Loading users...</p>
      </div>
    </div>
  </div>
</div>
